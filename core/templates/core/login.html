{# core/templates/core/login.html #}
{% extends 'core/base.html' %}
{% load static %}

{% block title %}Login - HomEstate{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center min-vh-100 p-3">
  <div class="card shadow-sm w-100" style="max-width: 400px;">
    <!-- Header con logo y título -->
    <div class="login-header text-center px-4 pt-4">
      <img src="{% static 'core/img/logo.png' %}" alt="Logo" class="img-fluid logo-img mb-2" style="height: 60px;">
      <h4 class="mb-1">HomEstate</h4>
      <p class="text-secondary">Ingrese sus credenciales para continuar</p>
    </div>

    <!-- Contenedor de mensajes -->
    <div id="messageContainer" class="alert d-none mx-4" role="alert"></div>
    {% include 'core/components/_login_form.html' %}
  </div>
</div>
{% endblock %}

{% block scripts %}

  <script>
    // 2) Inicializas Firebase (ya habrás declarado firebaseConfig en algún script antes).
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

   

    // 4) Si ya hay usuario autenticado, ir directo al dashboard
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Nota: 'admin' debe ser el nombre correcto de tu URL en urls.py
        window.location.href = "{% url 'admin' %}";
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 5) Toggle eye/eye-slash para mostrar/ocultar contraseña
      const togglePassword = document.querySelector('.toggle-password');
      const passwordInput = document.getElementById('password');
      const rememberCheckbox = document.getElementById('remember');

      // 6) Cargar credenciales guardadas (si existe “Recuérdame”)
      const savedUsername = localStorage.getItem('username');
      const savedPassword = localStorage.getItem('password');
      if (savedUsername && savedPassword) {
        document.getElementById('email').value = savedUsername;
        document.getElementById('password').value = savedPassword;
        rememberCheckbox.checked = true;
      }

      if (togglePassword) {
        togglePassword.addEventListener('click', () => {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);
          togglePassword.querySelector('i').classList.toggle('fa-eye');
          togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
        });
      }

      // 7) Enlaces de “Registrarme” y “Olvidé mi contraseña”
      const registerLink = document.getElementById('registerLink');
      if (registerLink) {
        registerLink.addEventListener('click', (e) => {
          e.preventDefault();
          alert('Funcionalidad de registro en desarrollo');
        });
      }
      const forgotLink = document.querySelector('.forgot-password');
      if (forgotLink) {
        forgotLink.addEventListener('click', (e) => {
          e.preventDefault();
          alert('Funcionalidad de recuperación de contraseña en desarrollo');
        });
      }

      // 8) Aquí vinculamos tu función login() al submit del formulario
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', login);
      }
    });

    // 9) Función para mostrar mensajes temporales (alertas)
    function showMessage(message, type = 'warning') {
      const container = document.getElementById('messageContainer');
      container.textContent = message;
      container.className = 'alert alert-' + type + ' mx-4';
      container.classList.remove('d-none');
      setTimeout(() => {
        container.classList.add('d-none');
      }, 5000);
    }

    // 10) Ahora login utiliza la instancia de auth que definimos antes
    function login(event) {
    event.preventDefault();

    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => {
        showMessage('¡Inicio de sesión exitoso! Redirigiendo...', 'success');
        if (rememberCheckbox.checked) {
          localStorage.setItem('username', email);
          localStorage.setItem('password', pass);
        } else {
          localStorage.removeItem('username');
          localStorage.removeItem('password');
        }
        setTimeout(() => {
          window.location.href = "{% url 'admin' %}";
        }, 1000);
      })
      .catch(error => {
        console.log(error.code);
        // Interceptamos el código de error de Firebase:
        switch (error.code) {
          case 'auth/user-not-found':
            showMessage('Usuario no encontrado.', 'warning');
            break;
          case 'auth/wrong-password':
            showMessage('Contraseña incorrecta.', 'warning');
            break;
          case 'auth/invalid-email':
            showMessage('Formato de correo inválido.', 'warning');
            break;
          case 'auth/invalid-login-credentials':
            showMessage('Formato de correo inválido.', 'warning');
          break;
          default:
            // Para cualquier otro error, usamos el mensaje genérico:
            showMessage('Error de inicio de sesión: Verifique sus credenciales.', 'danger');
        }
      });
  }
  </script>

{% endblock %}
